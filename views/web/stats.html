{{ extend "layout.html" }}
  <div id="content">
    {{if check_logged_in (): }}
    <div id="insert-new-event">
      <a href="{{= URL (r = request, f = 'insert', args = [str (event['_id'])]) }}">Edit Event Stats</a> | <a href="{{= URL (r = request, c = 'wiki', f = 'blog', args = [str (event['_id']), 'edit']) }}">Edit Event Wiki</a> | <a href="{{= URL (r = request, f = 'delete', args = [str (event['_id'])]) }}">Delete This Event</a>
    </div>    
    {{ pass }}
    <header>
      <div class="event-title">{{= event['event_name'] }}</div>
    </header>

    <!--<div id="location">
      <img class="loc" src="{{= URL (r = request, c = 'static', f='temp/screen.png') }}" />
      <figcaption>Outbreak Location</figcaption>
    </div>-->

    <div id="stats">
      {{for field in event_fields: }}
      {{ if field.get ('type') != 'hidden': }}
      {{ key = field['name'] }}
      <p><label>{{= field.get ('label') or key }}</label>{{= format_field (field, event.get (key)) }}</p>
      {{ pass }}
      {{ pass }}
    </div>
    
    <div id="right">
      <div style="height: 400px;" id="map">
      </div>
      <div id="wiki">
	<h2>Wiki</h2>
	{{=plugin_wiki.render (page.body) }}
      </div>
      <div id="references">
	<h2>References</h2>
	<p>{{ for ref in event['references']: }}
{{= mongo.refs.find_one ({
	         '_id': ref
	     })['title'] 
         }}</p>
	{{ pass }}
      </div>
    </div>
  </div>
  
  <footer>
  </footer>

  <script type="text/javascript">
    $ (document).ready (function () {
	$.ajax ({
	    url: '{{= URL (r = request, c = "static/maps", f = str (event.get ("map"))) + ".json" }}',
	    dataType: 'json',
	    success: function (data) {
		var map = new Map ('#map');

		var aspect = map.width () / map.height ();

		layer = GeoJSON (data);
		var bounds = layer.bounds;
		map.vcenter (bounds.centroid ());

		var extent = 2 * Math.max (bounds.width (), bounds.height () * aspect)
		map.extents (Math.min (extent, 360));

		map.append (layer);
	    }
	});

    });
  </script>